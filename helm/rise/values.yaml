# Default values for rise
replicaCount: 1

image:
  repository: ghcr.io/niklasrosenstein/rise
  pullPolicy: IfNotPresent
  tag: ""  # Overrides the image tag whose default is the chart appVersion

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

serviceAccount:
  create: true
  annotations: {}
  name: ""

podAnnotations: {}

podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 1000

securityContext:
  capabilities:
    drop:
    - ALL
  readOnlyRootFilesystem: true
  allowPrivilegeEscalation: false

# Environment variables from ConfigMaps and Secrets
# Applied to all containers (server and controllers)
envFrom: []
  # - secretRef:
  #     name: rise-env-secrets
  # - configMapRef:
  #     name: rise-env-config

service:
  type: ClusterIP
  port: 3000
  targetPort: 3000

ingress:
  enabled: false
  className: "nginx"
  annotations: {}
    # cert-manager.io/cluster-issuer: letsencrypt-prod
  hosts:
    - host: rise.example.com
      paths:
        - path: /
          pathType: Prefix
  tls: []
  #  - secretName: rise-tls
  #    hosts:
  #      - rise.example.com

# Server container resources
server:
  resources:
    limits:
      cpu: 1000m
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 128Mi

autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 10
  targetCPUUtilizationPercentage: 80
  # targetMemoryUtilizationPercentage: 80

nodeSelector: {}

tolerations: []

affinity: {}

# Rise backend configuration (TOML format)
# This is passed directly to the ConfigMap without any processing
config: |
  [server]
  host = "0.0.0.0"
  port = 3000
  public_url = "http://rise.example.com"

  [auth]
  issuer = "http://dex:5556/dex"
  client_id = "rise-backend"
  # admin_users = ["admin@example.com"]

  [database]
  # Database URL should be set via environment variable DATABASE_URL from a Secret

  [registry]
  type = "oci-client-auth"
  registry_url = "registry.example.com"
  namespace = "rise-apps"

  # Uncomment to enable Kubernetes controller
  #
  # IMPORTANT: namespace_format should use a consistent prefix for security.
  # Rise requires ClusterRole permissions (Kubernetes RBAC doesn't support namespace wildcards).
  # Use a consistent prefix (e.g., "rise-") and enforce it with:
  #   - Admission controllers (OPA/Gatekeeper)
  #   - Namespace naming policies
  #   - Audit logging
  #
  # [kubernetes]
  # ingress_class = "nginx"
  # domain_suffix = "apps.rise.net"
  # namespace_format = "rise-{project_name}"  # MUST use consistent prefix for security

# PostgreSQL dependency (optional, can use external database)
postgresql:
  enabled: false
  auth:
    username: rise
    password: rise123
    database: rise
  primary:
    persistence:
      enabled: true
      size: 8Gi

# Controllers configuration
# All controllers run as sidecar containers in the main deployment pod
controllers:
  # Deployment controller - manages application deployments
  deployment:
    enabled: true
    # Type can be "deployment-kubernetes" or "deployment-docker"
    type: "deployment-kubernetes"
    resources:
      limits:
        cpu: 500m
        memory: 256Mi
      requests:
        cpu: 50m
        memory: 64Mi

  # Project controller - handles project lifecycle
  project:
    enabled: true
    resources:
      limits:
        cpu: 200m
        memory: 128Mi
      requests:
        cpu: 20m
        memory: 32Mi

  # ECR controller - manages ECR repository credentials
  ecr:
    enabled: true
    resources:
      limits:
        cpu: 200m
        memory: 128Mi
      requests:
        cpu: 20m
        memory: 32Mi

# Dex OIDC provider (optional)
dex:
  enabled: false
  replicaCount: 1

  image:
    repository: ghcr.io/dexidp/dex
    tag: v2.40.0
    pullPolicy: IfNotPresent

  imagePullSecrets: []

  podAnnotations: {}

  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 1001
    fsGroup: 1001

  securityContext:
    capabilities:
      drop:
      - ALL
    readOnlyRootFilesystem: true
    allowPrivilegeEscalation: false

  service:
    type: ClusterIP
    port: 5556
    grpcPort: 5557

  resources:
    limits:
      cpu: 500m
      memory: 256Mi
    requests:
      cpu: 100m
      memory: 64Mi

  nodeSelector: {}
  tolerations: []
  affinity: {}

  # Issuer URL for Dex OIDC provider
  # This will be injected into the Dex config as the 'issuer' field
  issuerUrl: "http://dex:5556/dex"

  # Dex configuration (YAML format)
  # If empty, uses the default config from files/dex-config.yaml
  # If provided, this overrides the default config entirely
  # See https://dexidp.io/docs/
  config: ""
